name: Convert PPT to PDF and Image

on:
  push:
    paths:
      - '*.ppt'
      - '*.pptx'

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Get the latest ppt/pptx files
      id: get_files
      run: |
        echo "Getting the latest ppt/pptx files..."
        FILES=$(git diff --name-only HEAD^ HEAD | grep -E '\.ppt$|\.pptx$')
        echo "Found files: $FILES"
        echo "::set-output name=files::$FILES"

    - name: Convert PPT/PPTX to PDF
      if: steps.get_files.outputs.files != ''
      run: |
        echo "Converting PPT/PPTX files to PDF..."
        sudo apt-get update
        sudo apt-get install -y libreoffice
        for file in ${{ steps.get_files.outputs.files }}; do
          echo "Converting $file to PDF..."
          libreoffice --headless --convert-to pdf "$file"
        done

    - name: Convert PDF to Image
      if: steps.get_files.outputs.files != ''
      run: |
        echo "Converting PDF files to images..."
        sudo apt-get install -y imagemagick
        for file in ${{ steps.get_files.outputs.files }}; do
          PDF_FILE="${file%.*}.pdf"
          echo "Converting $PDF_FILE to image..."
          convert -density 300 "$PDF_FILE" -quality 100 "${PDF_FILE%.pdf}.png"
        done

    - name: Commit changes
      if: steps.get_files.outputs.files != ''
      run: |
        echo "Committing changes..."
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add *.png
        git commit -m 'Add converted images'
        git push
        echo "Changes pushed successfully."
